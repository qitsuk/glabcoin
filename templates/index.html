<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GlabCoin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
     {% include 'header.html' %}
    <div class="container">
        <img src="{{ url_for('static', filename='coin.png') }}" class="logo" alt="GlabCoin Logo" />
        <h1>Welcome to GlabCoin</h1>
        <p>The future of cryptocurrency is now old man!</p>

        <div class="stats">
        <p><strong>Price:</strong> $<span id="price">{{ price }}</span></p>
        <p><strong>Market Cap:</strong> $<span id="market_cap">{{ market_cap | comma_format }}</span></p>
        <p><strong>Circulating Supply:</strong> <span id="supply">{{ supply | comma_format }}</span> coins</p>
        </div>
        <canvas id="priceChart" width="400" height="200" style="margin-top: 2rem;"></canvas>
    </div>
</body>
<script>
let chart = null;

async function fetchDataAndDraw() {
  const res = await fetch('/data');
  const data = await res.json();

  if (!data.length) return;

  const latest = data[data.length - 1];
  const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
  const prices = data.map(d => parseFloat(d.price.toFixed(4)));
  const supplies = data.map(d => d.supply);

  // âœ… Update stats
  document.getElementById("price").textContent = latest.price.toFixed(4);
  document.getElementById("supply").textContent = latest.supply.toLocaleString();
  const marketCap = (latest.price * latest.supply).toFixed(2);
  document.getElementById("market_cap").textContent = parseFloat(marketCap).toLocaleString();

  // âœ… Chart setup
  const chartData = {
    labels,
    datasets: [
      {
        label: 'GlabCoin Price ($)',
        data: prices,
        borderColor: '#4FC3F7',
        backgroundColor: 'rgba(33, 150, 243, 0.2)',
        yAxisID: 'y1',
        tension: 0.3
      },
      {
        label: 'GlabCoin Supply',
        data: supplies,
        borderColor: '#81C784',
        backgroundColor: 'rgba(129, 199, 132, 0.2)',
        yAxisID: 'y2',
        tension: 0.3
      }
    ]
  };

  const chartOptions = {
    responsive: true,
    animation: false,
    scales: {
      x: { title: { display: true, text: 'Time' } },
      y1: {
        type: 'linear',
        position: 'left',
        title: { display: true, text: 'Price ($)' },
        ticks: { callback: v => '$' + v }
      },
      y2: {
        type: 'linear',
        position: 'right',
        title: { display: true, text: 'Supply' },
        grid: { drawOnChartArea: false },
        ticks: { callback: v => v.toLocaleString() }
      }
    }
  };

  const ctx = document.getElementById('priceChart').getContext('2d');

  // ðŸ§¹ Destroy existing chart before reinitializing
  if (chart) {
    chart.destroy();
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: chartOptions
  });
}

fetchDataAndDraw();
setInterval(fetchDataAndDraw, 10000);
</script>
</html>

